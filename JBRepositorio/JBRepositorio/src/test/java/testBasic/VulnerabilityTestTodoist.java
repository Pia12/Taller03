package testBasic;

import clientAPI.CustomResponse;
import clientAPI.FactoryRequest;

import io.qameta.allure.Attachment;
import io.qameta.allure.Description;
import io.qameta.allure.Step;
import io.qameta.allure.junit4.DisplayName;
import org.json.JSONException;
import org.junit.After;
import org.junit.Test;

import util.JsonUtil;

/**
 * @autor : eynar.pari
 * @date : 08/08/2020.
 **/
public class VulnerabilityTestTodoist {
    String idScan;

    @Test
    @DisplayName("Vulnerability Test OWASP ZAP")
    @Description("Ejecutar el test de vulneravilidad usando API")
    public void runVulnerabilityTest() throws JSONException, InterruptedException {
        this.idScan=this.startScan();
        this.monitoringScanning(idScan);
    }

    @After
    public void generarReportHTML() throws JSONException {
        // summary
        String endpoint="http://127.0.0.1:8888/HTML/ascan/view/scanProgress/?scanId="+this.idScan;
        CustomResponse customResponse=FactoryRequest.make("get").send(endpoint,"");
        this.attachHtml("Summary Progress",customResponse.getResponseBody());

        // reporte html
        String endpoint2="http://127.0.0.1:8888/OTHER/core/other/htmlreport/?";
        customResponse=FactoryRequest.make("get").send(endpoint2,"");
        this.attachHtml("Detail Report HTML",customResponse.getResponseBody());

    }

    @Attachment(value = "{0}", type="text/html")
    public static String attachHtml(String  name,String html){
        return html;
    }


    @Step("Start Vulnerability Test using OWASP ZAP")
    public String startScan() throws JSONException {
        String endpoint="http://127.0.0.1:8888/JSON/ascan/action/scan/?url=https%3A%2F%2Ftodoist.com%2F&recurse=&inScopeOnly=&scanPolicyName=&method=&postData=&contextId=";
        CustomResponse customResponse=FactoryRequest.make("get").send(endpoint,"");
        String id= JsonUtil.getJsonValue(JsonUtil.convertToJSONObject(customResponse.getResponseBody()),"scan");
        return id;
    }
    @Step("Monitoring Scan ZAP 100%")
    public void monitoringScanning(String idScan) throws InterruptedException, JSONException {
        String endpoint="http://127.0.0.1:8888/JSON/ascan/view/status/?scanId="+idScan;
        String isCompleted="";
        // esperando a que el scan sea 100%

        while (!isCompleted.equals("100")) {
            Thread.sleep(30000);
            CustomResponse customResponse=FactoryRequest.make("get").send(endpoint,"");
            isCompleted=JsonUtil.getJsonValue(JsonUtil.convertToJSONObject(customResponse.getResponseBody()),"status");
            System.out.println("OWASP status % "+isCompleted);
        }
    }
}